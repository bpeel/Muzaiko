#!/usr/bin/env bash

RRD_FILE_NAME='/var/muzaiko/auxskultantoj.rrd'
RRDTOOL='rrdtool'
CURRENT_TIMESTAMP=$(date '+%s')

if [ ! -f ${RRD_FILE_NAME} ]
then
	STEP=60
	VARIABLE_NAME='auxskultantoj'
	DATA_SOURCE_TYPE='GAUGE'
	HEARTBEAT=$((STEP * 2))
	MIN_VALUE=0
	MAX_VALUE=U

	MINUTE_CONSOLIDATION_FUNCTION='AVERAGE'
	MINUTE_XFF=0.5
	MINUTE_STEP=1
	MINUTE_ROWS=60

	HOUR_CONSOLIDATION_FUNCTION='AVERAGE'
	HOUR_XFF=0.5
	HOUR_STEP=60
	HOUR_ROWS=60

	DAY_CONSOLIDATION_FUNCTION='AVERAGE'
	DAY_XFF=0.5
	DAY_STEP=$((24 * 60))
	DAY_ROWS=24

	MONTH_CONSOLIDATION_FUNCTION='AVERAGE'
	MONTH_XFF=0.5
	MONTH_STEP=$((30 * 24 * 60))
	MONTH_ROWS=30

	YEAR_CONSOLIDATION_FUNCTION='AVERAGE'
	YEAR_XFF=0.5
	YEAR_STEP=$((12 * 30 * 24 * 60))
	YEAR_ROWS=31

	${RRDTOOL} create "${RRD_FILE_NAME}" \
		--step "${STEP}" \
		"DS:${VARIABLE_NAME}:${DATA_SOURCE_TYPE}:${HEARTBEAT}:${MIN_VALUE}:${MAX_VALUE}" \
		"RRA:${MINUTE_CONSOLIDATION_FUNCTION}:${MINUTE_XFF}:${MINUTE_STEP}:${MINUTE_ROWS}" \
		"RRA:${HOUR_CONSOLIDATION_FUNCTION}:${HOUR_XFF}:${HOUR_STEP}:${HOUR_ROWS}" \
		"RRA:${DAY_CONSOLIDATION_FUNCTION}:${DAY_XFF}:${DAY_STEP}:${DAY_ROWS}" \
		"RRA:${MONTH_CONSOLIDATION_FUNCTION}:${MONTH_XFF}:${MONTH_STEP}:${MONTH_ROWS}" \
		"RRA:${YEAR_CONSOLIDATION_FUNCTION}:${YEAR_XFF}:${YEAR_STEP}:${YEAR_ROWS}"
fi

[ -w "${RRD_FILE_NAME}" ] || exit 1

CURL='curl'

URL="http://api.radionomy.com/currentaudience.cfm?radiouid=14694a7d-9023-4db1-86b4-d85d96cba181"

AUXSKULTANTOJ=$(${CURL} --silent "${URL}")

${RRDTOOL} update "${RRD_FILE_NAME}" ${CURRENT_TIMESTAMP}:${AUXSKULTANTOJ}

